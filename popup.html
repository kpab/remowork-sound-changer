<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Remowork Sound Changer</title>
  <link rel="stylesheet" href="popup.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Remowork Sound Changer</h1>
    </header>

    <!-- タブナビゲーション -->
    <nav class="tab-nav">
      <button class="tab-btn active" data-tab="sound">🔊 音声</button>
      <button class="tab-btn" data-tab="handsign">👋 検出</button>
      <button class="tab-btn" data-tab="virtual-camera">📷 送信</button>
      <button class="tab-btn" data-tab="llm">🤖 AI</button>
      <button class="tab-btn" data-tab="settings">⚙️</button>
    </nav>

    <!-- 音声設定タブ -->
    <div class="tab-content active" id="tab-sound">
      <div class="tab-header">
        <span>音声差し替え</span>
        <label class="toggle-switch">
          <input type="checkbox" id="enabled-toggle" checked>
          <span class="slider"></span>
        </label>
      </div>

      <!-- URL設定欄（将来用、現在は無効） -->
      <section class="url-section">
        <label class="section-label">対象URL（将来対応予定）</label>
        <input type="text" class="url-input" value="https://stage.remowork.biz/*" disabled>
        <input type="text" class="url-input" value="https://remowork.biz/*" disabled>
      </section>

      <main class="sound-list" id="sound-list">
        <!-- 動的に生成 -->
      </main>

      <div class="note">上限: 300MB / 10分</div>
    </div>

    <!-- ハンドサイン検出タブ -->
    <div class="tab-content" id="tab-handsign">
      <div class="tab-header">
        <span>ハンドサイン検出</span>
        <label class="toggle-switch">
          <input type="checkbox" id="handsign-enabled-toggle" checked>
          <span class="slider"></span>
        </label>
      </div>

      <section class="handsign-section">
        <label class="section-label">自分の名前（検出対象外）</label>
        <input type="text" class="text-input" id="handsign-myname" placeholder="ページから自動検出します">
      </section>

      <section class="handsign-section">
        <label class="section-label">検出対象</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="detect-target" value="all" checked>
            全員を検出
          </label>
          <label class="radio-label">
            <input type="radio" name="detect-target" value="selected">
            選択したメンバーのみ
          </label>
        </div>
        <div class="member-list" id="member-list" style="display: none;">
          <p class="note">Remoworkページで自動取得されます</p>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">通知設定</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="handsign-toast" checked>
            画面にトースト表示
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="handsign-sound" checked>
            通知音を鳴らす
          </label>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">通知音の種類</label>
        <select class="sound-mode" id="handsign-sound-preset">
          <!-- 動的に生成される -->
        </select>
        <div class="sound-controls" style="margin-top: 8px;">
          <button class="btn btn-play" id="test-handsign-sound" title="再生">
            <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7z"/>
            </svg>
          </button>
          <label class="btn btn-upload" title="カスタム音声をアップロード">
            <input type="file" accept="audio/*" id="handsign-custom-upload" hidden>
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
            </svg>
          </label>
        </div>
        <div class="sound-file-info" id="handsign-custom-file-info"></div>
      </section>

      <section class="handsign-section">
        <label class="section-label">検出するジェスチャー</label>
        <div class="gesture-list">
          <div class="gesture-item">
            <span class="gesture-emoji">👋</span>
            <span class="gesture-desc">手を開く → 話したそう</span>
          </div>
          <div class="gesture-item">
            <span class="gesture-emoji">👍</span>
            <span class="gesture-desc">サムズアップ → 話してもOK</span>
          </div>
        </div>
      </section>
    </div>

    <!-- 隠しモード: 仮想カメラ設定タブ -->
    <div class="tab-content" id="tab-virtual-camera">
      <div class="tab-header">
        <span>📷 仮想カメラ</span>
      </div>

      <section class="handsign-section">
        <label class="section-label">ハンドサイン画像を撮影・登録（各12枚まで）</label>
        <p class="note" style="margin-bottom: 12px;">撮影ごとにランダムで使用されます！</p>

        <div class="camera-info-box">
          <p>📷 Remoworkサイト上で撮影します</p>
          <p class="note">サイトのカメラ権限を使用するため、<br>ポップアップでは撮影できません</p>
        </div>

        <div class="camera-controls">
          <button class="btn btn-camera-action btn-primary" id="start-camera-btn">📷 撮影モーダルを開く</button>
        </div>
        <canvas id="camera-canvas" style="display: none;"></canvas>
      </section>

      <section class="handsign-section">
        <label class="section-label">👋 登録済み画像 (<span id="wave-count">0</span>/12)</label>
        <div class="registered-images-grid" id="wave-images-grid">
          <!-- 動的に生成 -->
        </div>
        <div class="image-grid-buttons">
          <button class="btn btn-default-images" id="default-wave-btn">デフォルト画像をセット</button>
          <button class="btn btn-danger btn-clear-all" id="clear-wave-btn" style="display: none;">全て削除</button>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">👍 登録済み画像 (<span id="thumbsup-count">0</span>/12)</label>
        <div class="registered-images-grid" id="thumbsup-images-grid">
          <!-- 動的に生成 -->
        </div>
        <div class="image-grid-buttons">
          <button class="btn btn-default-images" id="default-thumbsup-btn">デフォルト画像をセット</button>
          <button class="btn btn-danger btn-clear-all" id="clear-thumbsup-btn" style="display: none;">全て削除</button>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">使い方</label>
        <div class="usage-info">
          <p>1. カメラを起動して、ハンドサインのポーズを撮影</p>
          <p>2. 複数枚登録すると、送信時にランダムで選択</p>
          <p>3. Remoworkページのタイマー横のボタンで送信</p>
          <p>4. 写真が撮られたら自動で通常カメラに戻ります</p>
        </div>
      </section>
    </div>

    <!-- LLM設定タブ -->
    <div class="tab-content" id="tab-llm">
      <div class="tab-header">
        <span>🤖 AI構造化メモ</span>
        <label class="toggle-switch">
          <input type="checkbox" id="llm-enabled-toggle">
          <span class="slider"></span>
        </label>
      </div>

      <section class="handsign-section">
        <label class="section-label">LLMプロバイダー</label>
        <select class="sound-mode" id="llm-provider">
          <option value="gemini">Google Gemini（無料枠あり）</option>
          <option value="openai">OpenAI（GPT-4o等）</option>
          <option value="claude">Anthropic Claude</option>
          <option value="custom">カスタムAPI</option>
        </select>
      </section>

      <section class="handsign-section" id="llm-model-section">
        <label class="section-label">モデル</label>
        <select class="sound-mode" id="llm-model">
          <!-- 動的に生成 -->
        </select>
      </section>

      <section class="handsign-section">
        <label class="section-label">APIキー</label>
        <div class="api-key-input-wrapper">
          <input type="password" class="text-input" id="llm-api-key" placeholder="APIキーを入力">
          <button class="btn btn-icon" id="toggle-api-key-visibility" title="表示/非表示">
            👁
          </button>
        </div>
        <p class="note" id="llm-api-note">Geminiは無料枠で利用可能（15 RPM / 250 RPD）</p>
      </section>

      <section class="handsign-section" id="llm-custom-section" style="display: none;">
        <label class="section-label">カスタムAPIエンドポイント</label>
        <input type="text" class="text-input" id="llm-custom-endpoint" placeholder="https://api.example.com/v1/chat/completions">
        <p class="note">OpenAI互換のエンドポイントを指定</p>
      </section>

      <section class="handsign-section">
        <label class="section-label">構造化設定</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="llm-auto-structure" checked>
            録音中に自動で構造化（30秒ごと）
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="llm-extract-actions" checked>
            アクションアイテムを抽出
          </label>
          <label class="checkbox-label">
            <input type="checkbox" id="llm-extract-decisions" checked>
            決定事項を抽出
          </label>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">プロフィール情報（任意）</label>
        <p class="note" style="margin-bottom: 8px;">漢字変換や文脈理解の精度向上に使用します</p>
        <div class="profile-inputs">
          <input type="text" class="text-input" id="llm-profile-name" placeholder="名前（例: 山田 太郎）">
          <input type="text" class="text-input" id="llm-profile-company" placeholder="会社名（例: 株式会社サンプル）">
          <input type="text" class="text-input" id="llm-profile-role" placeholder="役職（例: エンジニア）">
          <textarea class="text-input" id="llm-profile-context" placeholder="その他の情報（よく使う専門用語、プロジェクト名など）" rows="2"></textarea>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">APIキーの取得方法</label>
        <div class="usage-info">
          <p><strong>Gemini（推奨・無料）:</strong></p>
          <p>1. <a href="https://aistudio.google.com/apikey" target="_blank">Google AI Studio</a>にアクセス</p>
          <p>2. 「Create API Key」をクリック</p>
          <p>3. キーをコピーして上に貼り付け</p>
          <br>
          <p><strong>OpenAI:</strong></p>
          <p><a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a></p>
          <br>
          <p><strong>Claude:</strong></p>
          <p><a href="https://console.anthropic.com/settings/keys" target="_blank">Anthropic Console</a></p>
        </div>
      </section>

      <section class="handsign-section">
        <button class="btn btn-primary" id="test-llm-connection" style="width: 100%;">
          🔌 接続テスト
        </button>
        <p class="note" id="llm-test-result" style="margin-top: 8px;"></p>
      </section>

      <hr class="section-divider">

      <!-- Whisper API設定 -->
      <div class="tab-header" style="margin-top: 16px;">
        <span>🎙️ 相手の声の文字起こし（Whisper）</span>
        <label class="toggle-switch">
          <input type="checkbox" id="whisper-enabled-toggle">
          <span class="slider"></span>
        </label>
      </div>

      <section class="handsign-section">
        <div class="info-box warning">
          <p>⚠️ タブ音声をキャプチャしてWhisper APIで文字起こしします</p>
          <p class="note">OpenAI APIキーが必要です（$0.006/分）</p>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">OpenAI APIキー（Whisper用）</label>
        <div class="api-key-input-wrapper">
          <input type="password" class="text-input" id="whisper-api-key" placeholder="sk-...">
          <button class="btn btn-icon" id="toggle-whisper-key-visibility" title="表示/非表示">
            👁
          </button>
        </div>
        <p class="note">上のLLM設定でOpenAIを選択している場合は同じキーが使えます</p>
      </section>

      <section class="handsign-section">
        <label class="section-label">言語</label>
        <select class="sound-mode" id="whisper-language">
          <option value="ja">日本語</option>
          <option value="en">英語</option>
          <option value="zh">中国語</option>
          <option value="ko">韓国語</option>
        </select>
      </section>

      <section class="handsign-section">
        <button class="btn btn-secondary" id="test-whisper-connection" style="width: 100%;">
          🔌 Whisper接続テスト
        </button>
        <p class="note" id="whisper-test-result" style="margin-top: 8px;"></p>
      </section>

      <section class="handsign-section">
        <label class="section-label">使い方</label>
        <div class="usage-info">
          <p>1. OpenAI APIキーを入力して有効化</p>
          <p>2. 録音開始時に「タブの音声を共有」を選択</p>
          <p>3. 相手の声が30秒ごとに自動で文字起こしされます</p>
          <p>4. 結果は「相手の発言」エリアに表示されます</p>
        </div>
      </section>
    </div>

    <!-- 設定タブ -->
    <div class="tab-content" id="tab-settings">
      <div class="tab-header">
        <span>⚙️ 設定</span>
      </div>

      <section class="handsign-section">
        <label class="section-label">使用統計の送信</label>
        <div class="checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="stats-enabled-toggle" checked>
            匿名の使用統計を送信する
          </label>
        </div>
        <p class="note">機能改善のため、匿名化された使用統計を収集します。個人を特定できる情報は含まれません。</p>
      </section>

      <section class="handsign-section">
        <label class="section-label">収集される情報</label>
        <div class="usage-info">
          <p>• 機能の使用回数（ハンドサイン、表情分析など）</p>
          <p>• 通話時間の合計（匿名）</p>
          <p>• エラー発生回数</p>
          <p>• 拡張機能のバージョン</p>
        </div>
        <p class="note" style="margin-top: 8px;">⚠️ 収集されない情報: 名前、会社名、通話内容、APIキーなど</p>
      </section>

      <section class="handsign-section">
        <button class="btn btn-secondary" id="send-stats-now" style="width: 100%;">
          📊 今すぐ統計を送信
        </button>
        <p class="note" id="stats-last-sent" style="margin-top: 8px;"></p>
      </section>

      <section class="handsign-section">
        <label class="section-label">現在の統計</label>
        <div class="stats-preview" id="stats-preview">
          <p class="note">読み込み中...</p>
        </div>
      </section>

      <section class="handsign-section">
        <label class="section-label">バージョン情報</label>
        <div class="usage-info">
          <p><strong>Remowork Sound Changer</strong></p>
          <p id="extension-version">v1.4.0</p>
        </div>
      </section>
    </div>

    <footer class="footer">
      <p class="version">v1.4.0</p>
    </footer>
  </div>

  <template id="sound-item-template">
    <div class="sound-item" data-id="">
      <div class="sound-header">
        <span class="sound-label"></span>
        <span class="sound-status"></span>
      </div>
      <p class="sound-description"></p>
      <div class="sound-controls">
        <select class="sound-mode">
          <option value="original">オリジナル</option>
          <!-- プリセット音声は動的に追加 -->
          <option value="custom">カスタム（アップロード）</option>
        </select>
        <button class="btn btn-play" title="再生">
          <svg class="icon-play" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="icon-stop" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
            <path d="M6 6h12v12H6z"/>
          </svg>
        </button>
        <label class="btn btn-upload" title="アップロード">
          <input type="file" accept="audio/*" hidden>
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 16h6v-6h4l-7-7-7 7h4v6zm-4 2h14v2H5v-2z"/>
          </svg>
        </label>
      </div>
      <div class="sound-file-info"></div>
    </div>
  </template>

  <audio id="preview-audio" hidden></audio>

  <script src="popup.js"></script>
</body>
</html>
